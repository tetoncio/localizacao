<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Finder - Informa√ß√µes do Pet</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 420px; width: 100%; background: rgba(255,255,255,0.95); border-radius: 24px; padding: 32px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px);} to {opacity:1; transform: translateY(0);} }
        .pet-photo { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 24px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; align-items:center; justify-content:center; color:#fff; font-size:14px; font-weight:500; text-align:center; box-shadow:0 8px 24px rgba(102,126,234,0.3); transition: transform .3s ease; cursor:pointer; overflow:hidden; }
        .pet-photo:hover { transform: scale(1.05); }
        .pet-photo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
        .pet-name { background: rgba(102,126,234,0.1); border:2px solid rgba(102,126,234,0.2); border-radius:16px; padding:16px; margin-bottom:16px; text-align:center; font-size:24px; font-weight:600; color:#2c3e50; }
        .info-item { background: rgba(255,255,255,0.8); border:2px solid rgba(0,0,0,0.1); border-radius:16px; padding:16px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; }
        .info-label { font-weight:600; color:#34495e; font-size:14px; }
        .info-value { color:#2c3e50; font-weight:500; }
        .address-section { margin:24px 0; padding:20px; background: rgba(52,152,219,0.1); border-radius:16px; border:2px solid rgba(52,152,219,0.2); }
        .address-title { font-weight:600; color:#2c3e50; margin-bottom:12px; font-size:16px; }
        .address-text { color:#34495e; line-height:1.5; margin-bottom:16px; }
        .map-container { width:100%; height:200px; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
        .location-btn { width:100%; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; border-radius:16px; padding:18px; font-size:16px; font-weight:600; cursor:pointer; transition: all .3s ease; box-shadow:0 4px 16px rgba(102,126,234,0.3); margin-top:24px; }
        .location-btn:disabled { background:#bdc3c7; cursor:not-allowed; box-shadow:none; }
        .status-message { margin-top:16px; padding:12px; border-radius:12px; text-align:center; font-weight:500; display:none; }
        .status-success { background: rgba(46,204,113,0.1); color:#27ae60; border:2px solid rgba(46,204,113,0.2); }
        .status-error { background: rgba(231,76,60,0.1); color:#e74c3c; border:2px solid rgba(231,76,60,0.2); }
        .emergency-info { background: rgba(231,76,60,0.1); border:2px solid rgba(231,76,60,0.2); border-radius:16px; padding:16px; margin-bottom:24px; text-align:center; }
        .emergency-title { color:#e74c3c; font-weight:600; font-size:18px; margin-bottom:8px; }
        .emergency-text { color:#c0392b; font-size:14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="emergency-info">
            <div class="emergency-title">üêæ Pet Perdido</div>
            <div class="emergency-text">Se voc√™ encontrou este pet, por favor ajude-nos a reun√≠-lo com sua fam√≠lia!</div>
        </div>

        <div class="pet-photo" id="petPhoto"><span>FOTO DO PET</span></div>
        <div class="pet-name" id="petName">Carregando...</div>

        <div class="info-item"><span class="info-label">Ra√ßa:</span><span class="info-value" id="petBreed">Carregando...</span></div>
        <div class="info-item"><span class="info-label">Idade:</span><span class="info-value" id="petAge">Carregando...</span></div>
        <div class="info-item"><span class="info-label">Peso:</span><span class="info-value" id="petWeight">Carregando...</span></div>
        <div class="info-item"><span class="info-label">Sexo:</span><span class="info-value" id="petGender">Carregando...</span></div>
        <div class="info-item"><span class="info-label">Cor:</span><span class="info-value" id="petColor">Carregando...</span></div>

        <div class="address-section">
            <div class="address-title">üìç Dados do Tutor</div>
            <div class="info-item"><span class="info-label">Nome do Tutor:</span><span class="info-value" id="ownerName">Carregando...</span></div>
            <div class="info-item"><span class="info-label">Telefone:</span><span class="info-value" id="ownerPhone">Carregando...</span></div>
            <div class="address-text" id="ownerAddress">Carregando endere√ßo...</div>
            <div class="map-container">
                <iframe id="mapFrame" width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="about:blank"></iframe>
            </div>
        </div>

        <button class="location-btn" id="locationBtn" onclick="sendLocation()">üìç Envie minha localiza√ß√£o para o tutor</button>
        <div class="status-message" id="statusMessage"></div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Config do seu projeto Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyDXR6NakEE4yB93rK5rSxG2-OUBPnqazgY",
          authDomain: "pet-locate-42222.firebaseapp.com",
          databaseURL: "https://pet-locate-42222-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "pet-locate-42222",
          storageBucket: "pet-locate-42222.firebasestorage.app",
          messagingSenderId: "320851125516",
          appId: "1:320851125516:web:440744a87b0984d47c9529",
          measurementId: "G-GL55SGR8V8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Telegram
        const TELEGRAM_BOT_TOKEN = '8062338455:AAEjOVXeZpJvG9FxapVtBUvaj4Y2s2F4gK8';
        let TELEGRAM_CHAT_ID = '';
        const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

        let petData = {};

        function isFiniteNumber(v){ const n = typeof v === 'string' ? parseFloat(v) : v; return Number.isFinite(n) ? n : null; }

        async function loadPetDataFromFirestore(){
            const urlParams = new URLSearchParams(window.location.search);
            const petId = urlParams.get('id');
            if(!petId){ showStatus('‚ùå ID do pet n√£o fornecido na URL. Ex: ?id=seu_id_do_pet', 'error'); console.error('Sem id na URL'); return; }
            try{
                console.log('Buscando pet id:', petId);
                const docRef = db.collection('pets').doc(petId);
                const doc = await docRef.get();
                if(!doc.exists){ showStatus('‚ùå Pet n√£o encontrado no banco de dados.', 'error'); console.error('Documento n√£o existe'); return; }
                petData = doc.data() || {};
                console.log('Dados recebidos do Firestore:', petData);

                TELEGRAM_CHAT_ID = petData.telegramChatId || '';
                // Normalizar tipos num√©ricos
                petData.ownerLat = isFiniteNumber(petData.ownerLat);
                petData.ownerLng = isFiniteNumber(petData.ownerLng);

                // Preencher UI
                setText('petName', petData.name);
                setText('petBreed', petData.breed);
                setText('petAge', petData.age);
                setText('petWeight', petData.weight);
                setText('petGender', petData.gender);
                setText('petColor', petData.color);
                setText('ownerName', petData.ownerName);
                setText('ownerPhone', petData.ownerPhone);
                document.getElementById('ownerAddress').innerHTML = (petData.ownerAddress || 'N/A').replace(/\n/g, '<br>');

                if(petData.photo){ document.getElementById('petPhoto').innerHTML = `<img src="${petData.photo}" alt="Foto do ${petData.name||'pet'}">`; }
                updateMap();
            }catch(err){ console.error('Erro ao carregar Firestore:', err); showStatus('‚ùå Erro ao carregar dados do pet. Verifique o ID.', 'error'); }
        }

        function setText(id, val){ document.getElementById(id).textContent = val || 'N/A'; }

        function updateMap(){
            const mapFrame = document.getElementById('mapFrame');
            if(Number.isFinite(petData.ownerLat) && Number.isFinite(petData.ownerLng)){
                const embedUrl = `https://maps.google.com/maps?q=${petData.ownerLat},${petData.ownerLng}&z=15&output=embed`;
                mapFrame.src = embedUrl;
            } else { mapFrame.src = 'about:blank'; console.warn('Sem coordenadas v√°lidas para o mapa'); }
        }

        async function sendLocation(){
            const btn = document.getElementById('locationBtn');
            if(!navigator.geolocation){ showStatus('Geolocaliza√ß√£o n√£o √© suportada neste dispositivo.', 'error'); return; }
            if(!TELEGRAM_CHAT_ID){ showStatus('‚ùå Chat ID do Telegram n√£o configurado para este pet.', 'error'); return; }
            btn.disabled = true; btn.textContent = 'Obtendo localiza√ß√£o...';
            try{
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;
                const address = await getAddressFromCoords(latitude, longitude);
                const message = `üö® LOCALIZA√á√ÉO DO PET ENCONTRADO! üö®\n\nüêæ Pet: ${petData.name||'N/A'}\nüë§ Tutor: ${petData.ownerName||'N/A'}\nüìû Contato: ${petData.ownerPhone||'N/A'}\nüìç Localiza√ß√£o atual: ${address}\nüó∫Ô∏è Coordenadas: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}\nüîó Google Maps: https://maps.google.com/?q=${latitude},${longitude}\n\n‚è∞ Hor√°rio: ${new Date().toLocaleString('pt-BR')}`;
                await sendTelegramMessage(message);
                showStatus('‚úÖ Localiza√ß√£o enviada com sucesso! O tutor foi notificado.', 'success');
                btn.textContent = '‚úÖ Localiza√ß√£o enviada!';
            }catch(err){ console.error('Erro ao enviar localiza√ß√£o:', err); showStatus('‚ùå Erro ao enviar localiza√ß√£o. Tente novamente.', 'error'); btn.disabled = false; btn.textContent = 'üìç Envie minha localiza√ß√£o para o tutor'; }
        }

        function getCurrentPosition(){ return new Promise((resolve,reject)=>{ navigator.geolocation.getCurrentPosition(resolve,reject,{ enableHighAccuracy:true, timeout:10000, maximumAge:60000 }); }); }

        async function getAddressFromCoords(lat,lng){
            try{ const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=pt`); const d = await r.json(); if(d.locality && d.principalSubdivision){ return `${d.locality}, ${d.principalSubdivision}, ${d.countryName}`;} return `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`; } catch(e){ console.warn('Reverse geocode falhou:', e); return `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`; }
        }

        async function sendTelegramMessage(message){
            const res = await fetch(TELEGRAM_API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode:'HTML' }) });
            if(!res.ok) throw new Error('Falha ao enviar mensagem via Telegram');
            return res.json();
        }

        function showStatus(message,type){ const el = document.getElementById('statusMessage'); el.textContent = message; el.className = `status-message status-${type}`; el.style.display='block'; if(type==='success'){ setTimeout(()=>{ el.style.display='none'; }, 5000);} }

        document.addEventListener('DOMContentLoaded', loadPetDataFromFirestore);
        document.getElementById('petPhoto').addEventListener('click', function(){ this.style.transform='scale(0.95)'; setTimeout(()=>{ this.style.transform='scale(1)'; }, 150); });
    </script>
</body>
</html>
